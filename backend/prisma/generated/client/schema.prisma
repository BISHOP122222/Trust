// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "./generated/client"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// --------------------------------------
// User & Role Management
// --------------------------------------
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("SALES_AGENT") // SUPER_ADMIN, ADMIN, SALES_MANAGER, SALES_AGENT, INVENTORY_MANAGER, CUSTOMER
  isActive  Boolean  @default(true)
  phone     String?
  bio       String?
  avatarUrl String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  orders    Order[] // Orders placed by this user (if customer)
  sales     Order[]         @relation("SoldBy") // Orders processed by this agent
  auditLogs AuditLog[]
  movements StockMovement[]
}

// --------------------------------------
// Product Catalog & Inventory
// --------------------------------------
model Category {
  id          String    @id @default(uuid())
  name        String    @unique
  description String?
  products    Product[]
}

model Product {
  id           String  @id @default(uuid())
  name         String
  description  String
  price        Float // In UGX
  sku          String? @unique
  serialNumber String? // Added for serial tracking at product level (if needed, though usually per item)
  brand        String?
  imageUrl     String?

  // Inventory
  stockQuantity     Int    @default(0)
  lowStockThreshold Int    @default(5)
  costPrice         Float? // Added for profit calculation

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  warrantyMonths Int @default(0)

  specs      ProductSpec[]
  orderItems OrderItem[]
  movements  StockMovement[]

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Supplier {
  id        String    @id @default(uuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  address   String?
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model ProductSpec {
  id        String  @id @default(uuid())
  productId String
  key       String
  value     String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
}

// --------------------------------------
// Sales & Orders
// --------------------------------------
model Order {
  id             String @id @default(uuid())
  orderNumber    String @unique // Human readable e.g. ORD-2023-1001
  status         String @default("PENDING") // PENDING, CONFIRMED, SHIPPED, DELIVERED, CANCELLED
  totalAmount    Float
  subtotal       Float // Amount before tax and discount
  taxAmount      Float  @default(0)
  discountAmount Float  @default(0)

  // Discount applied
  discountId String?
  discount   Discount? @relation(fields: [discountId], references: [id])
  couponCode String?

  // Relations
  customerId String?
  customer   User?   @relation(fields: [customerId], references: [id])

  agentId String?
  agent   User?   @relation("SoldBy", fields: [agentId], references: [id])

  items   OrderItem[]
  payment Payment?
  receipt Receipt?
  returns Return[]

  shippingAddress String?
  notes           String? // Optional notes for the order

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model OrderItem {
  id        String  @id @default(uuid())
  orderId   String
  order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float // Snapshot of price at time of sale
  costPrice Float? // Snapshot of cost price at time of sale

  serialNumber   String? // For electronics (IMEI/Serial)
  warrantyExpiry DateTime? // Calculated at sale time
}

model Payment {
  id             String   @id @default(uuid())
  orderId        String   @unique
  order          Order    @relation(fields: [orderId], references: [id])
  amount         Float // Amount paid
  amountTendered Float? // Amount given by customer (for cash)
  changeAmount   Float? // Change to give back
  method         String // CASH, MOBILE_MONEY, CARD, MIXED
  status         String // PENDING, COMPLETED, FAILED
  transactionId  String?
  reference      String? // Payment reference number
  createdAt      DateTime @default(now())
}

// --------------------------------------
// POS Features
// --------------------------------------
model Receipt {
  id            String    @id @default(uuid())
  orderId       String    @unique
  order         Order     @relation(fields: [orderId], references: [id])
  receiptNumber String    @unique
  content       String // JSON or text content of receipt
  printedAt     DateTime?
  reprintCount  Int       @default(0)
  createdAt     DateTime  @default(now())
}

model Discount {
  id          String    @id @default(uuid())
  code        String?   @unique // Coupon code (optional)
  name        String
  description String?
  type        String // PERCENTAGE, FIXED_AMOUNT
  value       Float // Percentage (0-100) or fixed amount
  minPurchase Float? // Minimum purchase amount to apply
  maxDiscount Float? // Maximum discount amount (for percentage)
  isActive    Boolean   @default(true)
  startDate   DateTime?
  endDate     DateTime?
  orders      Order[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model TaxConfig {
  id        String   @id @default(uuid())
  name      String // e.g. "VAT", "Sales Tax"
  rate      Float // Tax rate as percentage (e.g., 18 for 18%)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// --------------------------------------
// Advanced Management & Logs
// --------------------------------------
model StockMovement {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  type      String // IN, OUT, ADJUSTMENT, RETURN
  quantity  Int // Positive or negative
  reason    String // e.g., "Sale", "Restock", "Damaged", "Return"
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model Return {
  id          String       @id @default(uuid())
  orderId     String
  order       Order        @relation(fields: [orderId], references: [id])
  reason      String
  totalRefund Float
  status      String       @default("COMPLETED") // COMPLETED, PENDING
  items       ReturnItem[]
  createdAt   DateTime     @default(now())
}

model ReturnItem {
  id          String  @id @default(uuid())
  returnId    String
  return      Return  @relation(fields: [returnId], references: [id])
  orderItemId String
  quantity    Int
  condition   String? // e.g., "Good", "Defective"
}

model AuditLog {
  id         String   @id @default(uuid())
  action     String // e.g., "PRICE_CHANGE", "VOID_ORDER", "STOCK_ADJUSTMENT"
  entityType String // e.g., "PRODUCT", "ORDER"
  entityId   String
  userId     String
  user       User     @relation(fields: [userId], references: [id])
  oldValue   String? // JSON string representing old state
  newValue   String? // JSON string representing new state
  reason     String?
  createdAt  DateTime @default(now())
}

model BrandingSettings {
  id            String   @id @default(uuid())
  businessName  String   @default("TRUST POS")
  address       String?
  phone         String?
  email         String?
  logoUrl       String?
  footerMessage String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}
